<http ng-app="app">

    <head>
        <title>Home</title>
        <script src="scripts/vendor/angular.js"></script>
        <script src="scripts/vendor/firebase.js"></script>
        <script src="scripts/vendor/firebase-simple-login.js"></script>
        <script src="scripts/vendor/angularfire.js"></script>
    </head>

    <body>
        <div ng-controller="maincontroller">
            <button ng-show="loginObj.user" ng-click="logout()" style="float: right">logout</button>
            <h1>hello.</h1>
            <h5>{{ status }}</h5>
            <div ng-hide="loginObj.user">
                <form>
                    <input ng-disabled="logindisabled" type="email" ng-model="userlogin.email" placeholder="email" />
                    <input ng-disabled="logindisabled" type="password" ng-model="userlogin.password" placeholder="password" />
                    <button ng-disabled="logindisabled" type="submit" ng-click="login()">login</button>
                </form>
            </div>
            <div ng-show="loginObj.user">
                <form>
                    <input ng-model="newcategory.description" type="text"/>
                    <button type="submit" ng-click="addcategory()">add category</button>
                </form>

                <div ng-repeat="(catkey, category) in categories">
                    <h3>{{ category.description }}</h3>
                    <form>
                        <input ng-model="newitem.description" type="text" ng-enter="additem(catkey)"/>
                        <button type="submit" ng-click="additem(catkey)">add</button>
                    </form>
                    <table>
                        <tbody>
                        <tr ng-repeat="(itemkey, item) in category.items">
                            <td style="min-width: 250px;">{{ item.description }}</td>
                            <td><button ng-click="removeitem(catkey, itemkey)">x</button></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <script>
            var myApp = angular.module('app', ['firebase']);

            myApp.directive('ngEnter', function () {
                return function (scope, element, attrs) {
                    element.bind("keydown keypress", function (event) {
                        if(event.which === 13) {
                            scope.$apply(function (){
                                scope.$eval(attrs.ngEnter);
                            });

                            event.preventDefault();
                        }
                    });
                };
            });

            function maincontroller($scope, $firebase, $firebaseSimpleLogin) {


                $scope.logindisabled = true;
                $scope.newitem = {};
                var dataRef = new Firebase("https://jkalweit.firebaseio.com");
                $scope.loginObj = $firebaseSimpleLogin(dataRef);
                $scope.loginObj.$getCurrentUser().then(function (user) {
                    $scope.logindisabled = false;
                }, function (error) {
                    $scope.logindisabled = false;
                });


                var tasksRef = new Firebase("https://jkalweit.firebaseio.com/jkalweit/tasks");
                $scope.tasks = $firebase(tasksRef);
                $scope.categories = $scope.tasks.$child('categories');

                $scope.login = function () {
                    $scope.logindisabled = true;
                    $scope.status = 'Logging in...';
                    $scope.loginObj.$login('password', {
                        email: $scope.userlogin.email,
                        password: $scope.userlogin.password
                    }).then(function (user) {
                                $scope.status = '';
                                $scope.logindisabled = false;
                            },
                            function (error) {
                                $scope.status = 'Failed to login: ' + error;
                                $scope.logindisabled = false;
                    });
                };

                $scope.logout = function () {
                    $scope.loginObj.$logout();
                };

                $scope.additem = function (catkey) {

                    var category = $scope.categories.$child(catkey)
                    var items = category.$child('items');

                    items.$add($scope.newitem).then(function () {
                        $scope.status = '';
                        $scope.newitem = {};
                    }, function (error) {
                        $scope.status = 'failed to add task: ' + error;
                    });
                };
                $scope.removeitem = function (catkey, itemkey) {
                    var category = $scope.categories.$child(catkey);
                    var items = category.$child('items');
                    items.$remove(itemkey).then(function () {
                        $scope.status = '';
                    }, function (error) {
                        $scope.status = 'failed to delete item: ' + error;
                    });
                };
                $scope.addcategory = function () {
                    $scope.tasks.$child('categories').$add($scope.newcategory).then(function () {
                        $scope.status = '';
                        $scope.newcategory = {};
                    }, function (error) {
                        $scope.status = 'failed to add category: ' + error;
                    });
                };

            }
        </script>
    </body>

</http>
